<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>mybatis调用流程 | 王欣的博客</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="开源项目提交者,dubbo,rpc,apache,架构师,信息安全"><meta name="description" content="王欣，Apache Dubbo项目committer、PMC。专注于rpc、云原生、性能优化、信息安全相关的技术，拥抱开源。github：https://github.com/lovepoem email：xin.victorwang@gmail.com"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://wangxin.io/2014/07/05/framework/mybatis-process/index.html"><link rel="icon" type="image/png" href="/images/wangxin-min.png" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="王欣的博客"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?8dd700474b9448fa0d7db1f5e2236886";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async src="https://www.googletagmanager.com/gtag/js?id=G-1SDLZ60RR6"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1SDLZ60RR6")</script><link rel="stylesheet" href="/scss/views/page/post.css"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/images/loading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="王欣的博客" alt="王欣的博客"><img src="/images/wangxin.png" alt="王欣的博客"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/tags" alt="标签" title="标签">标签</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li><li class="nav__item"><a href="/linkedfriend" alt="menu.linkedfriend" title="menu.linkedfriend">menu.linkedfriend</a></li><li class="nav__item"><a href="https://github.com/lovepoem" alt="menu.github" title="menu.github">menu.github</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/images/mybatis.png" alt="mybatis调用流程"></div><header class="post__info"><h1 class="post__title">mybatis调用流程</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://wangxin.io">王欣</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2014-07-05</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/mybatis/">Mybatis</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><p>[TOC]</p><h3><span id="一-什么是mybatis">一、什么是MyBatis</span></h3><p>​ MyBatis 是支持定制化 SQL、存储过程以及高级映射的优秀的持久层框架。避免了几乎所有的 JDBC 代码和手动设置参数以及获取结果集。可以对配置和原生Map使用简单的 XML 或注解，将接口和 Java 的 POJOs(Plain Old Java Objects,普通的 Java对象)映射成数据库中的记录。MyBatis并不刻意于完成ORM(对象映射)的完整概念，而是旨在更简单、更方便地完成数据库操作功能，减轻开发人员的工作量.</p><p>​ 1.根据 JDBC 规范建立与数据库的连接；</p><p>​ 2.通过反射打通 Java 对象与数据库参数交互之间相互转化关系。</p><h3><span id="二-mybatis简单示例">二、MyBatis简单示例</span></h3><h4><span id="1-mybatis实例">1、mybatis实例</span></h4><p>​ 虽然在使用MyBatis时一般都会使用XML文件，但是本文为了分析程序的简单性，简单的测试程序将不包含XML配置，该测试程序包含一个接口、一个启动类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserMapper</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Select</span>(<span class="string">"SELECT * FROM user WHERE id = #&#123;id&#125;"</span>)</span><br><span class="line">  <span class="function">User <span class="title">selectUser</span><span class="params">(intid)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MybatisTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = initSqlSessionFactory();</span><br><span class="line">        SqlSession session = sqlSessionFactory.openSession();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            User user = (User) session.selectOne(<span class="string">"testmybatis.UserMapper.selectUser"</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="comment">//int total = session.delete("testmybatis.UserMapper.deleteById", 1);</span></span><br><span class="line">            <span class="comment">//System.out.println("total-----"+total);</span></span><br><span class="line">            System.out.println(user.getAddress());</span><br><span class="line">            System.out.println(user.getName());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            session.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory <span class="title">initSqlSessionFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DataSource dataSource = <span class="keyword">new</span> PooledDataSource(<span class="string">"com.mysql.jdbc.Driver"</span>, <span class="string">"jdbc:mysql://localhost:3306/test"</span>, <span class="string">"root"</span>, <span class="string">"root"</span>);</span><br><span class="line">        TransactionFactory transactionFactory = <span class="keyword">new</span> JdbcTransactionFactory();</span><br><span class="line">        Environment environment = <span class="keyword">new</span> Environment(<span class="string">"development"</span>, transactionFactory, dataSource);</span><br><span class="line">        Configuration configuration = <span class="keyword">new</span> Configuration(environment);</span><br><span class="line">        configuration.addMapper(UserMapper<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        SqlSessionFactory sqlSessionFactory = <span class="keyword">new</span> SqlSessionFactoryBuilder().build(configuration);</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> sqlSessionFactory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　UserMapper是一个接口，我们在构建sqlSessionFactory时通过configuration.addMapper(UserMapper.class)把该接口注册进了sqlSessionFactory中。从上面的代码中我们可以看出，要使用MyBatis，我们应该经过以下步骤：1、创建sqlSessionFactory（一次性操作）；2、用sqlSessionFactory对象构造sqlSession对象；3、调用sqlSession的相应方法；4、关闭sqlSession对象。</p><pre><code>在main方法中，我们没有配置sql，也没有根据查询结果拼接对象，只需在调用sqlSession方法时传入一个命名空间以及方法参数参数即可，所有的操作都是面向对象的。在UserMapper接口中，我们定制了自己的sql，MyBatis把书写sql的权利给予了我们，方便我们进行sql优化及sql排错。</code></pre><h4><span id="2-jdbc基础回顾">2、JDBC基础回顾</span></h4><p>​ 直接使用JDBC是很痛苦的，JDBC连接数据库包含以下几个基本步骤：1、注册驱动 ；2、建立连接(Connection)；3、创建SQL语句(Statement)；4、执行语句；5、处理执行结果(ResultSet)；6、释放资源，示例代码如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span>throwsSQLException</span>&#123;</span><br><span class="line">    <span class="comment">// 1.注册驱动</span></span><br><span class="line">    Class.forName(<span class="string">"com.mysql.jdbc.Driver"</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 2.建立连接  url格式 - JDBC:子协议:子名称//主机名:端口/数据库名？属性名=属性值&amp;...</span></span><br><span class="line">    Connection conn = DriverManager.getConnection(<span class="string">"jdbc:mysql://localhost:3306/jdbc"</span>,<span class="string">"root"</span>,<span class="string">""</span>;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 3.创建语句</span></span><br><span class="line">    Statement st = conn.createStatement();</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 4.执行语句</span></span><br><span class="line">    ResultSet rs = st.executeQuery(<span class="string">"select * from user"</span>);</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 5.处理结果</span></span><br><span class="line">    <span class="keyword">while</span>(rs.next()) &#123;　</span><br><span class="line">    　User user =newUser(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// 6.释放资源</span></span><br><span class="line">    rs.close();</span><br><span class="line">    st.close();</span><br><span class="line">    conn.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　可以看到与直接使用JDBC相比，MyBatis为我们简化了很多工作：</p><p>​ 1、把创建连接相关工作抽象成一个sqlSessionFactory对象，一次创建多次使用；</p><p>​ 2、把sql语句从业务层剥离，代码逻辑更加清晰，增加可维护性；</p><p>​ 3、自动完成结果集处理，不需要我们编写重复代码。</p><p>​ 但是，我们应该知道的是，框架虽然能够帮助我们简化工作，但是框架底层的代码肯定还是最基础的JDBC代码，因为这是Java平台连接数据库的通用方法，今天我将分析一下MyBatis源码，看看MyBatis是如何把这些基础代码封装成一个框架的。</p><h3><span id="三-mybatis-的架构体系">三、mybatis 的架构体系</span></h3><h4><span id="1-mybatis的功能架构">1、Mybatis的功能架构</span></h4><p><strong>分为三层（图片借用了百度百科）：</strong></p><p>1) API接口层：提供给外部使用的接口API，开发人员通过这些本地API来操纵数据库。接口层一接收到调用请求就会调用数据处理层来完成具体的数据处理。</p><p>2) 数据处理层：负责具体的SQL查找、SQL解析、SQL执行和执行结果映射处理等。它主要的目的是根据调用的请求完成一次数据库操作。</p><p>3) 基础支撑层：负责最基础的功能支撑，包括连接管理、事务管理、配置加载和缓存处理，这些都是共用的东西，将他们抽取出来作为最基础的组件。为上层的数据处理层提供最基础的支撑。</p><h4><span id="2-整体流程图">2、整体流程图</span></h4><p><img src="http://img.my.csdn.net/uploads/201306/09/1370783456_4126.JPG" alt="img"></p><p>​ 初始化Mybatis，所有的配置都在Configuration对象中 使用Mybatis，从SqlSessionFactory工厂中获取SqlSession，从Configuration对象中获取mapper对象，并返回结果 Mybatis在加载mapper的时候对mapper接口的注解进行解析 重要的几个包：io、session、builder、mapper（annotations、binding）、executor</p><p>​ 源代码主要在org.apache.ibatis目录下，18个包，其中在应用中主要的包有：builder、session、cache、type、transaction、datasource、jdbc、mapping，提供支撑服务的包有annotation、binding、io、logging、plugin、reflection、scripting、exception、executor、parsing</p><h4><span id="3-代码堆栈跟踪">3、代码堆栈跟踪</span></h4><p>我们最终调用的是sqlSession对象上的方法，所以我们先跟踪sqlSession的创建方法：sqlSessionFactory.openSession()，最终这个方法会调用到DefaultSqlSessionFactory的以下方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> SqlSession <span class="title">openSessionFromDataSource</span><span class="params">(ExecutorType execType, TransactionIsolationLevel level,booleanautoCommit)</span> </span>&#123;</span><br><span class="line">    Transaction tx =<span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      finalEnvironment environment = configuration.getEnvironment();</span><br><span class="line">      finalTransactionFactory transactionFactory = getTransactionFactoryFromEnvironment(environment);</span><br><span class="line">      tx = transactionFactory.newTransaction(environment.getDataSource(), level, autoCommit);</span><br><span class="line">      finalExecutor executor = configuration.newExecutor(tx, execType);</span><br><span class="line">      returnnewDefaultSqlSession(configuration, executor, autoCommit);</span><br><span class="line">    &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">      closeTransaction(tx);<span class="comment">// may have fetched a connection so lets call close()</span></span><br><span class="line">      throwExceptionFactory.wrapException(<span class="string">"Error opening session.  Cause: "</span>+ e, e);</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">      ErrorContext.instance().reset();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>　　最终返回的对象是一个DefaultSqlSession对象，在调试模式下，我们看到autoCommit为false，executor为CachingExecutor类型，在CachingExecutor里面有属性delegate，其类型为simpleExecutor：</p><p><img src="http://images.cnitblog.com/blog/677938/201412/131414173377016.png" alt="img"></p><p>​ 现在，我们跟进DefaultSqlSession的selectOne()方法，查看该方法的调用流程，selectOne()方法又会调用selectList()方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">selectList</span><span class="params">(String statement, Object parameter, RowBounds rowBounds)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    MappedStatement ms = configuration.getMappedStatement(statement);</span><br><span class="line">    List&lt;E&gt; result = executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);</span><br><span class="line">    returnresult;</span><br><span class="line">  &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">    throwExceptionFactory.wrapException(<span class="string">"Error querying database.  Cause: "</span>+ e, e);</span><br><span class="line">  &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    ErrorContext.instance().reset();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　可以看到要得到查询结果，最终还是要调用executor上的query方法，这里的executor是CachingExecutor实例，跟进程序得到如下代码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler)</span>throwsSQLException </span>&#123;</span><br><span class="line">  BoundSql boundSql = ms.getBoundSql(parameterObject);</span><br><span class="line">  CacheKey key = createCacheKey(ms, parameterObject, rowBounds, boundSql);</span><br><span class="line">  returnquery(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameterObject, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span></span></span><br><span class="line"><span class="function">    throwsSQLException </span>&#123;</span><br><span class="line">  Cache cache = ms.getCache();</span><br><span class="line">  <span class="keyword">if</span>(cache !=<span class="keyword">null</span>) &#123;</span><br><span class="line">    flushCacheIfRequired(ms);</span><br><span class="line">    <span class="keyword">if</span>(ms.isUseCache() &amp;&amp; resultHandler ==<span class="keyword">null</span>) &#123;</span><br><span class="line">      ensureNoOutParams(ms, parameterObject, boundSql);</span><br><span class="line">      <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">      List&lt;E&gt; list = (List&lt;E&gt;) tcm.getObject(cache, key);</span><br><span class="line">      <span class="keyword">if</span>(list ==<span class="keyword">null</span>) &#123;</span><br><span class="line">        list = delegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">        tcm.putObject(cache, key, list);<span class="comment">// issue #578. Query must be not synchronized to prevent deadlocks</span></span><br><span class="line">      &#125;</span><br><span class="line">      returnlist;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  returndelegate.&lt;E&gt; query(ms, parameterObject, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MyBatis框架首先生成了一个boundSql和CacheKey，在boundSql中包含有我们传入的sql语句</p><p>​ 生成boundSql和CacheKey后会调用一个重载函数，在重载函数中，我们会检测是否有缓存，这个缓存是MyBatis的二级缓存，我们没有配置，那么直接调用最后一句delegate.<e>query(ms, parameterObject, rowBounds, resultHandler, key, boundSql)，前面说过这个delagate其实就是simpleExecutor，跟进去查看一下：</e></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span>throwsSQLException </span>&#123;</span><br><span class="line">    ErrorContext.instance().resource(ms.getResource()).activity(<span class="string">"executing a query"</span>).object(ms.getId());</span><br><span class="line">    <span class="keyword">if</span>(closed)thrownewExecutorException(<span class="string">"Executor was closed."</span>);</span><br><span class="line">    <span class="keyword">if</span>(queryStack ==<span class="number">0</span>&amp;&amp; ms.isFlushCacheRequired()) &#123;</span><br><span class="line">      clearLocalCache();</span><br><span class="line">    &#125;</span><br><span class="line">    List&lt;E&gt; list;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">      queryStack++;</span><br><span class="line">      list = resultHandler ==<span class="keyword">null</span>? (List&lt;E&gt;) localCache.getObject(key) :<span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span>(list !=<span class="keyword">null</span>) &#123;</span><br><span class="line">        handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">      &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">      queryStack--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(queryStack ==<span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span>(DeferredLoad deferredLoad : deferredLoads) &#123;</span><br><span class="line">        deferredLoad.load();</span><br><span class="line">      &#125;</span><br><span class="line">      deferredLoads.clear();<span class="comment">// issue #601</span></span><br><span class="line">      <span class="keyword">if</span>(configuration.getLocalCacheScope() == LocalCacheScope.STATEMENT) &#123;</span><br><span class="line">        clearLocalCache();<span class="comment">// issue #482</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    returnlist;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>　　关键代码是以下三行：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">list = resultHandler ==<span class="keyword">null</span>? (List&lt;E&gt;) localCache.getObject(key) :<span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">  handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">  list = queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　首先尝试从localCache中根据key得到List，这里的localCache是MyBatis的一级缓存，如果得不到则调用queryFromDatabase()从数据库中查询：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">queryFromDatabase</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, CacheKey key, BoundSql boundSql)</span>throwsSQLException </span>&#123;</span><br><span class="line">  List&lt;E&gt; list;</span><br><span class="line">  localCache.putObject(key, EXECUTION_PLACEHOLDER);</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    list = doQuery(ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">  &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    localCache.removeObject(key);</span><br><span class="line">  &#125;</span><br><span class="line">  localCache.putObject(key, list);</span><br><span class="line">  <span class="keyword">if</span>(ms.getStatementType() == StatementType.CALLABLE) &#123;</span><br><span class="line">    localOutputParameterCache.putObject(key, parameter);</span><br><span class="line">  &#125;</span><br><span class="line">  returnlist;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>​ 其中关键代码是调用doQuery()代码，SimpleExecutor的doQuery()方法如下：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocalContainer.setRequestString(paramString);</span><br><span class="line">  </span><br><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">doQuery</span><span class="params">(MappedStatement ms, Object parameter, RowBounds rowBounds, ResultHandler resultHandler, BoundSql boundSql)</span>throwsSQLException </span>&#123;</span><br><span class="line">  Statement stmt =<span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    Configuration configuration = ms.getConfiguration();</span><br><span class="line">    StatementHandler handler = configuration.newStatementHandler(wrapper, ms, parameter, rowBounds, resultHandler, boundSql);</span><br><span class="line">    stmt = prepareStatement(handler, ms.getStatementLog());</span><br><span class="line">    returnhandler.&lt;E&gt;query(stmt, resultHandler);</span><br><span class="line">  &#125;<span class="keyword">finally</span>&#123;</span><br><span class="line">    closeStatement(stmt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　调用了prepareStatement方法，该方法如下：</p><p>　　终于，我们看到熟悉的代码了，首先得到Connection，然后从Connection中得到Statement，同时在调试模式下我们看到，我们的sql语句已经被设置到stmt中了：</p><p><img src="http://images.cnitblog.com/blog/677938/201412/131511151502445.png" alt="img"></p><p>　　现在Statement对象有了，sql也设置进去了，就只差执行以及对象映射了，继续跟进代码，我们会跟踪到org.apache.ibatis.executor.statement.</p><p>PreparedStatementHandler类的executor方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;E&gt; <span class="function">List&lt;E&gt; <span class="title">query</span><span class="params">(Statement statement, ResultHandler resultHandler)</span> throwsSQLException </span>&#123;</span><br><span class="line">  PreparedStatement ps = (PreparedStatement) statement;</span><br><span class="line">  ps.execute();</span><br><span class="line">  <span class="keyword">return</span> resultSetHandler.&lt;E&gt; handleResultSets(ps);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>　　在这里，调用了ps.execute()方法执行sql，接下来调用的resultSetHandler.<e>handleResultSets(ps)方法明显是对结果集进行封装。</e></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FastResultSetHandler</span> <span class="keyword">implements</span> <span class="title">ResultSetHandler</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> List <span class="title">handleResultSets</span><span class="params">(Statement stmt)</span> <span class="keyword">throws</span> SQLException </span>&#123;</span><br><span class="line">        List multipleResults = <span class="keyword">new</span> ArrayList();</span><br><span class="line">        List resultMaps = mappedStatement.getResultMaps();</span><br><span class="line">        <span class="keyword">int</span> resultMapCount = resultMaps.size();</span><br><span class="line">        <span class="keyword">int</span> resultSetCount = <span class="number">0</span>;</span><br><span class="line">        ResultSet rs = stmt.getResultSet();</span><br><span class="line">        label0: <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">do</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rs != <span class="keyword">null</span>)</span><br><span class="line">                    <span class="keyword">break</span> label0;</span><br><span class="line">                <span class="keyword">if</span> (!stmt.getMoreResults())</span><br><span class="line">                    <span class="keyword">continue</span> label0;</span><br><span class="line">                rs = stmt.getResultSet();</span><br><span class="line">            &#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">while</span> (stmt.getUpdateCount() != -<span class="number">1</span>);</span><br><span class="line">        validateResultMapsCount(rs, resultMapCount);</span><br><span class="line">        <span class="keyword">for</span> (; rs != <span class="keyword">null</span> &amp;&amp; resultMapCount &gt; resultSetCount; resultSetCount++) &#123;</span><br><span class="line">            ResultMap resultMap = (ResultMap) resultMaps.get(resultSetCount);</span><br><span class="line">            handleResultSet(rs, resultMap, multipleResults);</span><br><span class="line">            rs = getNextResultSet(stmt);</span><br><span class="line">            cleanUpAfterHandlingResultSet();</span><br><span class="line">        &#125;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> collapseSingleResultList(multipleResults);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3><span id="四-api文档">四、api文档</span></h3><h4><span id="1-mybatis-中文">1、mybatis 中文</span></h4><p><a href="http://mybatis.github.io/mybatis-3/zh/index.html">http://mybatis.github.io/mybatis-3/zh/index.html</a></p><h4><span id="2-mybatis-接口">2、mybatis 接口</span></h4><p><a href="http://mybatis.github.io/mybatis-3/zh/xref/index.html">http://mybatis.github.io/mybatis-3/zh/xref/index.html</a></p><div class="post-announce">感谢您的阅读，本文由 <a href="https://wangxin.io">王欣的博客</a> 版权所有。如若转载，请注明出处：王欣的博客（<a href="https://wangxin.io/2014/07/05/framework/mybatis-process/">https://wangxin.io/2014/07/05/framework/mybatis-process/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2014/06/05/framework/workflow/" title="浅谈工作流引擎"><i class="iconfont icon-prev"></i>浅谈工作流引擎</a></div><div class="post__prev post__prev--right"><a href="/2018/02/12/java/java_lambda_implement/" title="Java lambda表达式(三)——实现原理">Java lambda表达式(三)——实现原理<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">王欣，Apache Dubbo项目committer、PMC。专注于rpc、云原生、性能优化、信息安全相关的技术，拥抱开源。github：https://github.com/lovepoem email：xin.victorwang@gmail.com</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E6%88%91%E7%9C%8B/">我看</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%AD%98%E5%82%A8/">存储</a><span class="block-list-count">1</span><ul class="block-list-child"><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%AD%98%E5%82%A8/redis/">redis</a><span class="block-list-count">1</span></li></ul></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/spring/">spring</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/shell/">shell</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/mybatis/">mybatis</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/mq/">mq</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/jvm/">jvm</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/java/">java</a><span class="block-list-count">3</span><ul class="block-list-child"><li class="block-list-item"><a class="block-list-link" href="/categories/java/lambda%E8%A1%A8%E8%BE%BE%E5%BC%8F/">lambda表达式</a><span class="block-list-count">3</span></li></ul></li><li class="block-list-item"><a class="block-list-link" href="/categories/hide/">hide</a><span class="block-list-count">7</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/github/">github</a><span class="block-list-count">1</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/dubbo/">dubbo</a><span class="block-list-count">4</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/apache%E6%B5%81%E7%A8%8B/">apache流程</a><span class="block-list-count">2</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2019/12/08/mq/rocketmq-dead-message/" title="RocketMQ的死信队列你了解多少？怎么实现的？"><div class="item__cover"><img src="/images/java.png" alt="RocketMQ的死信队列你了解多少？怎么实现的？"></div><div class="item__info"><h3 class="item__title">RocketMQ的死信队列你了解多少？怎么实现的？</h3><span class="item__text">2019-12-08</span></div></a></li><li class="latest-post-item"><a href="/2019/12/03/dubbo/dubbo-service-connection-count-control/" title="Dubbo服务间的连接是怎么控制处理的？"><div class="item__cover"><img src="/images/dubbo.png" alt="Dubbo服务间的连接是怎么控制处理的？"></div><div class="item__info"><h3 class="item__title">Dubbo服务间的连接是怎么控制处理的？</h3><span class="item__text">2019-12-03</span></div></a></li><li class="latest-post-item"><a href="/2019/10/31/distributed/distributed_system_consistency_algorithm_paxos_raft_zab/" title="Seata 基本原理和源码分析"><div class="item__cover"><img src="/images/java.png" alt="Seata 基本原理和源码分析"></div><div class="item__info"><h3 class="item__title">Seata 基本原理和源码分析</h3><span class="item__text">2019-10-31</span></div></a></li><li class="latest-post-item"><a href="/2019/10/31/distributed/distributed_transaction_seata/" title="分布式事务一致性算法Paxos、raft、zab等的比较"><div class="item__cover"><img src="/images/java.png" alt="分布式事务一致性算法Paxos、raft、zab等的比较"></div><div class="item__info"><h3 class="item__title">分布式事务一致性算法Paxos、raft、zab等的比较</h3><span class="item__text">2019-10-31</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/apache%E6%B5%81%E7%A8%8B/">apache流程</a></li><li class="tag-item"><a class="tag-link" href="/tags/dubbo/">dubbo</a></li><li class="tag-item"><a class="tag-link" href="/tags/github/">github</a></li><li class="tag-item"><a class="tag-link" href="/tags/hide/">hide</a></li><li class="tag-item"><a class="tag-link" href="/tags/java8/">java8</a></li><li class="tag-item"><a class="tag-link" href="/tags/jvm/">jvm</a></li><li class="tag-item"><a class="tag-link" href="/tags/lambda/">lambda</a></li><li class="tag-item"><a class="tag-link" href="/tags/mq/">mq</a></li><li class="tag-item"><a class="tag-link" href="/tags/mybatis/">mybatis</a></li><li class="tag-item"><a class="tag-link" href="/tags/redis/">redis</a></li><li class="tag-item"><a class="tag-link" href="/tags/spring5/">spring5</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/">多线程</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B7%A5%E4%BD%9C%E6%B5%81/">工作流</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B9%B6%E8%A1%8C/">并行</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%BC%82%E6%AD%A5/">异步</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%88%91%E7%9C%8B/">我看</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%BB%9F%E8%AE%A1/">统计</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">王欣的博客，工作生活的一些思考。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Beijing, China</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>xin.victorwang@gmail.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="/images/me.png" alt="logo" title="王欣的博客"></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="http://blog.didispace.com/" title="程序猿DD" target="_blank">程序猿DD</a></li><li class="list-item"><a href="http://www.iocoder.cn" title="纯源码解析博客" target="_blank">芋道源码</a></li><li class="list-item"><a href="http://www.ityouknow.com" title="纯洁的微笑" target="_blank">纯洁的微笑</a></li><li class="list-item"><a href="http://blog.720ui.com/" title="梁桂钊的博客" target="_blank">梁桂钊的博客</a></li><li class="list-item"><a href="https://fookwood.com" title="闷瓜蛋子的BLOG" target="_blank">闷瓜蛋子的BLOG</a></li><li class="list-item"><a href="http://www.itmuch.com/" title="周立的博客" target="_blank">周立的博客</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>. <span id="busuanzi_container_site_pv">Total number of visits：<span id="busuanzi_value_site_pv"></span></span>&nbsp;Total visitor number:<span id="busuanzi_value_site_uv"></span></p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/lovepoem" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:xin.victorwang@gmail.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="https://weibo.com/wangxinvictor" target="_blank" title="weibo"><i class="iconfont icon-weibo"></i></a></li><li class="social-network__item"><a href="https://twitter.com/wangxinvictor" target="_blank" title="twitter"><i class="iconfont icon-twitter"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["mybatis"],gitalk=new Gitalk({clientID:"dfeb42da2955f5c18a8f",clientSecret:"ec47674c973490128eda38c44beef41d08fe7ce5",repo:"lovepoem.github.io",owner:"lovepoem",admin:["lovepoem"],labels:tags,id:new Date(1404496862e3).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>